# 環境変数（APIキー等）の取得・準備方法

`SET_ENV_VARS.sh` に設定が必要な各キーの取得方法をまとめました。

## 1. SENDGRID_API_KEY (メール送信)
SendGridはメール送信サービスです。Magic Link（ログイン用）や通知メールの送信に使用します。

1.  [SendGrid](https://sendgrid.com/) にアクセスし、アカウントを作成（またはログイン）します。
2.  ダッシュボード左側のメニューから **Settings** > **API Keys** を選択します。
3.  **Create API Key** をクリックします。
4.  **API Key Name** に適当な名前（例: `KarteAI_Func`）を入力します。
5.  **API Key Permissions** は **Full Access** または **Restricted Access** (Mail Send 権限のみ) を選択します。
6.  **Create & View** をクリックし、表示されたキー（`SG.`から始まる文字列）をコピーします。
    *   **注意**: キーは一度しか表示されません。必ずコピーして控えてください。

## 2. JWT_SECRET (認証トークン署名)
ログイン状態を保持するトークンの暗号化に使用する秘密鍵です。

*   **取得方法**: 任意のランダムな文字列で構いません。
*   **生成コマンド例**: ターミナルで以下を実行すると、安全なランダム文字列が生成されます。
    ```bash
    openssl rand -hex 32
    ```
    出力された文字列（例: `a1b2c3...`）を使用します。

## 3. Stripe 関連 (決済・サブスクリプション)
Stripeは決済プラットフォームです。まずは**テストモード**で設定することをお勧めします。

[Stripe ダッシュボード](https://dashboard.stripe.com/) にログインし、右上の「**テスト環境**」スイッチをONにしてください。

### A. STRIPE_SECRET_KEY
1.  ダッシュボードの **開発者** > **APIキー** を開きます。
2.  **シークレットキー** の「テストキーを表示」をクリックします。
3.  表示されたキー（`sk_test_`から始まる文字列）をコピーします。

### B. STRIPE_PRICE_ID
1.  ダッシュボードの **商品** を開きます。
2.  **商品を登録** をクリックします。
    *   **名前**: 例「Karte AI+ Pro Plan」
    *   **価格情報**:
        *   **価格**: 例 `3980`
        *   **通貨**: `JPY`
        *   **請求期間**: `月次`
3.  商品を保存すると、価格セクションに **API ID** が表示されます。
4.  `price_` から始まるIDをコピーします。

### C. STRIPE_WEBHOOK_SECRET
Stripeでのイベント（支払い完了、解約など）をAzure Functionsに通知するための設定です。

1.  ダッシュボードの **開発者** > **Webhook** を開きます。
2.  **エンドポイントを追加** をクリックします。
3.  **エンドポイントURL** に以下を入力します（あなたのAzure FunctionsのURLです）:
    ```
    https://func-karte-ai-1763705952.azurewebsites.net/api/stripe-webhook
    ```
4.  **送信するイベント** の「イベントを選択」をクリックし、以下をチェックして追加します:
    *   `checkout.session.completed`
    *   `customer.subscription.updated`
    *   `customer.subscription.deleted`
5.  **エンドポイントを追加** をクリックして保存します。
6.  作成された画面の「**署名シークレット**」にある「表示」をクリックします。
7.  表示されたキー（`whsec_`から始まる文字列）をコピーします。

---

全てのキーが揃ったら、`SET_ENV_VARS.sh` を編集して値を貼り付け、スクリプトを実行してください。
