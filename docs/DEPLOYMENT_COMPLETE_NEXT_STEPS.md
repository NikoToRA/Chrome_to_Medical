# ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº† - æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

**æ—¥æ™‚**: 2025-11-30  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… Function Appã®ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†

---

## âœ… å®Œäº†ã—ãŸã“ã¨

1. **Function Appã®å†ãƒ‡ãƒ—ãƒ­ã‚¤**
   - æ”¹å–„ç‰ˆã®`auth-verify-token`ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
   - ãƒ­ã‚°å‡ºåŠ›ã‚’è¿½åŠ ï¼ˆ`[AuthVerifyToken]`ï¼‰
   - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’æ”¹å–„
   - ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯ã‚’å¼·åŒ–

2. **ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ**
   - Remote build succeeded!
   - ã™ã¹ã¦ã®é–¢æ•°ãŒæ­£å¸¸ã«ç™»éŒ²

---

## ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### ã‚¹ãƒ†ãƒƒãƒ—1: Function Appã‚’å†èµ·å‹•ï¼ˆå®Œäº†ã—ãŸã‚‰ã‚¹ãƒ†ãƒƒãƒ—2ã¸ï¼‰

```bash
az functionapp restart --name func-karte-ai-1763705952 --resource-group rg-karte-ai
```

### ã‚¹ãƒ†ãƒƒãƒ—2: æ•°åˆ†å¾…ã¤

Function Appã®å†èµ·å‹•ã«ã¯**1-2åˆ†**ã‹ã‹ã‚Šã¾ã™ã€‚

### ã‚¹ãƒ†ãƒƒãƒ—3: æ–°ã—ã„Magic Linkã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

1. **LPãƒ•ã‚©ãƒ¼ãƒ **ã«ã‚¢ã‚¯ã‚»ã‚¹: https://stkarteai1763705952.z11.web.core.windows.net/
2. ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã—ã¦é€ä¿¡
3. ãƒ¡ãƒ¼ãƒ«ã‚’å—ä¿¡ï¼ˆ15åˆ†ä»¥å†…ã«ç¢ºèªï¼‰

### ã‚¹ãƒ†ãƒƒãƒ—4: Magic Linkã‚’ã‚¯ãƒªãƒƒã‚¯

1. ãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ä»¥ä¸‹ã®ã„ãšã‚Œã‹ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãšï¼š
   - âœ… **æˆåŠŸ**: Stripe Checkoutãƒšãƒ¼ã‚¸ã«è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
   - âš ï¸ **ã‚¨ãƒ©ãƒ¼**: æ”¹å–„ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ï¼ˆè©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»˜ãï¼‰

### ã‚¹ãƒ†ãƒƒãƒ—5: Application Insightsã§ãƒ­ã‚°ã‚’ç¢ºèª

1. Azure Portal â†’ Function App â†’ ç›£è¦– â†’ ãƒ­ã‚°
2. ä»¥ä¸‹ã®ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œï¼š

```kusto
traces
| where timestamp > ago(30m)
| where message contains "AuthVerifyToken"
| order by timestamp desc
| take 50
```

**æœŸå¾…ã•ã‚Œã‚‹ãƒ­ã‚°**:
```
[AuthVerifyToken] Configuration check: { hasStripe: true, ... }
[AuthVerifyToken] Creating Stripe Checkout session: { email: "...", ... }
[AuthVerifyToken] Stripe Checkout session created successfully: { sessionId: "...", ... }
```

---

## ğŸ” ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### å•é¡Œ1: ã¾ã 401ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹

**ç¢ºèªäº‹é …**:
1. Function AppãŒå†èµ·å‹•ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
2. æ–°ã—ã„Magic Linkã‚’ä½¿ã£ã¦ã„ã‚‹ã‹ç¢ºèªï¼ˆå¤ã„ãƒˆãƒ¼ã‚¯ãƒ³ã¯ç„¡åŠ¹ï¼‰
3. Application Insightsã§ãƒ­ã‚°ã‚’ç¢ºèª

### å•é¡Œ2: ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œãªã„

**å¯¾å‡¦æ³•**:
1. æ•°åˆ†å¾…ã£ã¦ã‹ã‚‰å†åº¦ç¢ºèª
2. æ™‚é–“ç¯„å›²ã‚’åºƒã’ã‚‹ï¼ˆ`ago(1h)`ï¼‰

### å•é¡Œ3: ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹

**ç¢ºèªäº‹é …**:
1. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª
2. Application Insightsã§ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª
3. ç’°å¢ƒå¤‰æ•°ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

---

## ğŸ“ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [x] Function Appã®å†ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
- [ ] Function Appã®å†èµ·å‹•å®Œäº†
- [ ] æ–°ã—ã„Magic Linkã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
- [ ] Magic Linkã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å‹•ä½œç¢ºèª
- [ ] Application Insightsã§ãƒ­ã‚°ã‚’ç¢ºèª

---

## ğŸ¯ æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ

1. **Magic Linkã‚’ã‚¯ãƒªãƒƒã‚¯**
   ```
   https://func-karte-ai-1763705952.azurewebsites.net/api/auth-verify-token?token=xxx
   ```

2. **ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼æˆåŠŸ**
   - JWTãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼
   - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ

3. **Stripe Checkoutã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ**
   - Stripe APIã‚’å‘¼ã³å‡ºã—
   - Checkoutã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ

4. **ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ**
   - HTTP 302ãƒ¬ã‚¹ãƒãƒ³ã‚¹
   - `Location: https://checkout.stripe.com/c/pay/cs_test_xxx`

5. **Stripe Checkoutè¡¨ç¤º**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ±ºæ¸ˆæƒ…å ±ã‚’å…¥åŠ›

---

**ä½œæˆè€…**: AI Assistant  
**æœ€çµ‚æ›´æ–°**: 2025-11-30

