# Debug Log: Receipt Email Delivery Fix
**Date:** 2025-12-11
**Status:** Resolved
**Feature:** Stripe Webhook Receipt Email (`invoice.payment_succeeded`)

## Issue Description
Users were not receiving PDF receipt emails after a successful payment specific event. While "Magic Link" emails were working, the receipt automation triggered by Stripe was failing silently or with errors during testing.

## Root Causes Identified

1.  **Environment Variable Mismatch**
    *   **Problem:** The code in `utils/email.js` was looking for `ACS_CONNECTION_STRING`, but the Azure Function App only had `AZURE_COMMUNICATION_CONNECTION_STRING` configured (which was being used successfully by `lib/email.js`).
    *   **Fix:** Updated `utils/email.js` to fallback to `lib/email.js` logic and check for the correct `AZURE_COMMUNICATION_CONNECTION_STRING`.

2.  **Unauthorized Sender Address**
    *   **Problem:** The email sender was defaulting to `support@wonder-drill.com` (from `company.json`). This domain was not verified/authorized in the Azure Communication Services resource, causing the API to reject the request.
    *   **Fix:** Updated the sender logic to use the Azure Managed Domain address (`DoNotReply@...azurecomm.net`) which is pre-authorized.

3.  **Missing Attachment Support**
    *   **Problem:** The standardized `lib/email.js` function used for Magic Links did not support the `attachments` options, so when we refactored `utils/email.js` to use it, the PDF was dropped.
    *   **Fix:** Updated `lib/email.js` to accept and pass the `attachments` array to the Azure SDK.

4.  **Webhook Signature Mismatch (HTTP 400)**
    *   **Problem:** The `stripe trigger` command works by triggering a remote event. The Azure Function rejected these events because the `STRIPE_WEBHOOK_SECRET` environment variable in Azure did not match the signature secret of the active Webhook Endpoint in Stripe.
    *   **Fix:** 
        1. Created a new clean Webhook Endpoint using Stripe CLI.
        2. Retrieved the new `whsec_...` key.
        3. Updated the Azure Function App URL and `STRIPE_WEBHOOK_SECRET` using Azure CLI.

## Verification
- **Method:** `stripe trigger invoice.payment_succeeded --override customer:email=super206cc@gmail.com`
- **Result:**
    - Azure Function returned HTTP 200.
    - Email received at `super206cc@gmail.com`.
    - PDF Receipt attached and legible.

## Key Files Modified
- `azure-functions/utils/email.js` (Refactored to use lib)
- `azure-functions/lib/email.js` (Added attachment support)
- `azure-functions/stripe-webhook/index.js` (Logic flow confirmed)

---
*Log generated by Antigravity Assistant*
