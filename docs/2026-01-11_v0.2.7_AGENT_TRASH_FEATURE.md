# v0.2.7 エージェント削除時のゴミ箱機能

**日付**: 2026-01-11
**バージョン**: 0.2.7
**種別**: 新機能

## 概要

エージェント削除時に即座にリモートDBに反映されてしまい、復元できない問題を解決するため、ゴミ箱機能を実装しました。

## 問題の背景

v0.2.6以前では、エージェントを削除すると：
1. ローカルストレージから削除
2. **自動的にリモートDBにPush**（即座に同期）
3. 削除されたエージェントは復元不可能

これにより、誤って削除した場合に復元する手段がありませんでした。

## 解決策

「ハイブリッド方式」を採用：

1. **削除時は自動Pushしない** - リモートには即座に反映されない
2. **ローカルに7日間保持** - 削除済みエージェントとして一時保存
3. **復元 or 7日経過後にリモートからも削除** - 次回Push時に反映

## 実装内容

### storage.js

```javascript
// 新しいストレージキー
AI_DELETED_AGENTS: 'aiDeletedAgents'

// 新しい定数
DELETED_AGENT_RETENTION_DAYS = 7  // 保持期間
MAX_DELETED_AGENTS = 8            // 最大保持数

// 新しいメソッド
- getDeletedAgents()              // 削除済みエージェント取得
- saveDeletedAgents()             // 削除済みエージェント保存
- addToDeletedAgents(agent)       // 削除済みリストに追加
- removeFromDeletedAgents(id)     // 削除済みリストから削除（復元/完全削除時）
- cleanupExpiredDeletedAgents()   // 期限切れをクリーンアップ
- getActiveDeletedAgents()        // 有効な削除済みエージェント取得
```

### options.js

```javascript
// 変更点
- handleDeleteAgent(): 削除済みリストに追加、自動Pushスキップ
- persistAgents(): skipAutoSyncオプション追加

// 新しい関数
- renderDeletedAgents()           // 削除済みUI描画
- handleRestoreAgent(id)          // 復元処理
- handlePermanentDeleteAgent(id)  // 完全削除処理
- setupDeletedAgentsEvents()      // イベントハンドラ設定
```

### options.html

```html
<!-- 新しいセクション -->
<details>
  <summary>🗑️ 最近削除したエージェント（7日間復元可能）</summary>
  <div id="deletedAgentsList">
    <!-- 動的に挿入 -->
  </div>
</details>
```

### importSyncedSettings (storage.js)

Pull時に削除済みリストにあるエージェントは復活させない：

```javascript
const deletedAgentIds = new Set(deletedAgents.map(a => a.id));
remoteAgents.forEach(a => {
  if (!deletedAgentIds.has(a.id)) {
    agentMap.set(a.id, a);
  }
});
```

## 動作フロー

```
[削除ボタン押下]
    ↓
確認ダイアログ「7日間はローカルに保持され、復元可能です」
    ↓
エージェントを deletedAgents に移動
    ↓
自動Pushはスキップ（リモートには反映されない）
    ↓
■ 復元する場合
   └→「復元」ボタン → 元のリストに戻る → 自動Push
■ 完全削除する場合
   └→「完全削除」ボタン → deletedAgentsから削除
■ 7日経過
   └→ 次回ページロード時にクリーンアップ
■ Push実行
   └→ リモートに現状（削除後）が反映される
```

## UI

設定画面のエージェントセクション下部に折りたたみ式のゴミ箱セクションを追加：

- 削除済みエージェント名
- 削除日
- 残り日数
- 「復元」ボタン
- 「完全削除」ボタン

## 制約事項

- 最大保持数: 8件（エージェント上限と同じ）
- 保持期間: 7日間
- ストレージ: ローカルのみ（リモートには保存しない）

## テスト手順

1. 拡張機能をリロード
2. AI設定センターを開く
3. エージェントを削除 → 「7日間復元可能」メッセージを確認
4. 「最近削除したエージェント」を展開 → 削除したエージェントが表示される
5. 「復元」ボタンで復元できることを確認
6. 「クラウドから取得」しても削除済みエージェントが復活しないことを確認

## 関連ファイル

- `extensions/utils/storage.js`
- `extensions/options/options.js`
- `extensions/options/options.html`
- `extensions/manifest.json`
- `extensions/CHANGELOG.txt`
