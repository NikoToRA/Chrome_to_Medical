# v0.2.5x サブスクリプション管理要件

**作成日**: 2026-01-12
**対象バージョン**: v0.2.51, v0.2.52
**Google Web Store公開版**: v0.2.5

---

## 概要

Stripeを使ったサブスクリプション管理において、ユーザー体験を損なわずに適切な課金状態管理を実現する。

---

## ビジネス要件

### サブスクリプションライフサイクル

```
申し込み → 14日間トライアル → 自動課金 → 継続利用
                                    ↓
                              キャンセル可能
                                    ↓
                              月末まで利用可能
                                    ↓
                              再課金で即復帰
```

### 運営側の操作

- Stripe管理画面からトライアル期間を延長可能
- 延長は24時間以内にユーザーに反映される

---

## 技術要件

### 1. サブスクリプション状態判定（サーバー側）

**ファイル**: `azure-functions/check-subscription/index.js`

| Stripe status | 判定条件 | active | 備考 |
|---------------|----------|--------|------|
| `trialing` | trialEnd > now | `true` | トライアル中 |
| `trialing` | trialEnd ≤ now | `false` | トライアル終了・未課金 |
| `active` | periodEnd > now | `true` | 課金中 |
| `active` | periodEnd ≤ now | `false` | 課金期間終了 |
| `canceled` | periodEnd > now | `true` | キャンセル済み・猶予期間 |
| `canceled` | periodEnd ≤ now | `false` | 完全終了 |
| `past_due` | periodEnd > now | `true` | 決済失敗・リトライ中（猶予） |
| `past_due` | periodEnd ≤ now | `false` | 決済失敗・期間終了 |
| その他 | - | `false` | 未知のステータス |

### 2. クライアント側チェック方針

**目的**: 通信コスト削減 & ユーザー体験向上

#### チェックタイミング

| タイミング | 動作 | APIコール |
|-----------|------|-----------|
| サイドパネル起動時 | キャッシュ使用 | なし（24h以内） |
| ログイン/再ログイン時 | 強制チェック | あり |
| 24時間ごと | バックグラウンドチェック | あり |

#### キャッシュ仕様

```javascript
// storage.js
SUBSCRIPTION_CACHE: 'subscriptionCache',      // サブスク状態
LAST_SUBSCRIPTION_CHECK: 'lastSubscriptionCheck'  // 最終チェック日時

// キャッシュ構造
{
  active: boolean,
  hasSubscriptionRecord: boolean,
  status: string,
  expiry: string,
  trialEnd: string,
  trialDaysRemaining: number,
  checkedAt: string  // ISO 8601
}
```

#### TTL（Time To Live）

- キャッシュ有効期間: **24時間**
- 24時間経過後は次回チェック時にAPIコール

### 3. 自動ログアウト方針

**v0.2.5で廃止**

| 状況 | v0.2.4以前 | v0.2.5以降 |
|------|-----------|-----------|
| サブスク無効 | 自動ログアウト | ログアウトしない（UIでブロック） |
| ネットワークエラー | 自動ログアウト | トークン保持（次回再試行） |
| トークン形式エラー | 自動ログアウト | 自動ログアウト（維持） |

**理由**:
- 一時的なサーバーエラーでログアウトされる問題を防止
- Stripe Webhook遅延による誤判定を防止

### 4. 再課金後の即時利用

**要件**: 再課金したユーザーはすぐに拡張機能を使いたい

**実装**:
```javascript
// auth.js - loginWithToken()
async loginWithToken(token) {
  // ... トークン処理 ...

  // v0.2.52: ログイン時は必ず最新のサブスク状態を取得
  await this.checkSubscription(true); // forceRefresh = true
}
```

- 再ログインボタンをクリック → `loginWithToken()` 呼び出し
- `checkSubscription(true)` で強制APIコール
- キャッシュ更新 → 即座に利用可能

### 5. バックグラウンドチェック

**ファイル**: `extensions/background.js`

```javascript
// インストール時にalarm設定
chrome.runtime.onInstalled.addListener(() => {
  chrome.alarms.create('dailySubscriptionCheck', {
    periodInMinutes: 1440 // 24時間
  });
});

// alarm発火時の処理
chrome.alarms.onAlarm.addListener(async (alarm) => {
  if (alarm.name === 'dailySubscriptionCheck') {
    await performDailySubscriptionCheck();
  }
});
```

**目的**:
- Stripeトライアル延長の反映（運営操作後24h以内）
- サブスク期限切れの検出（翌朝から使えなくなる）

---

## UI要件

### サブスク無効時の表示分岐

```javascript
// sidepanel.js
const hasRecord = window.AuthManager.hasSubscriptionRecord;

if (!hasRecord) {
  // 新規ユーザー: サブスクリプション開始ボタン表示
} else {
  // 既存ユーザー（期限切れ）: お支払い情報更新ボタン表示
}
```

### 再ログインボタン

未ログイン状態で表示:
```html
<button id="goToReloginBtn">
  既にアカウントをお持ちの方 → 再ログイン
</button>
```

---

## 権限要件

**manifest.json**:
```json
{
  "permissions": [
    "sidePanel",
    "storage",
    "tabs",
    "clipboardWrite",
    "scripting",
    "offscreen",
    "alarms"  // v0.2.52で追加
  ]
}
```

---

## テストシナリオ

### 正常系

1. **新規登録 → トライアル開始**
   - 期待: 14日間利用可能

2. **トライアル → 自動課金**
   - 期待: シームレスに継続利用

3. **キャンセル → 月末まで利用**
   - 期待: periodEndまで利用可能

4. **再課金 → 即時利用**
   - 期待: 再ログインで即座に利用可能

5. **トライアル延長（運営操作）**
   - 期待: 24時間以内に反映

### 異常系

1. **決済失敗（past_due）**
   - 期待: periodEndまで猶予期間として利用可能

2. **ネットワークエラー**
   - 期待: ログアウトせず、キャッシュを使用

3. **サーバーエラー（500）**
   - 期待: ログアウトせず、次回再試行

---

## 関連ファイル

| ファイル | 役割 |
|---------|------|
| `azure-functions/check-subscription/index.js` | サブスク状態判定API |
| `extensions/utils/auth.js` | 認証・サブスク管理 |
| `extensions/utils/storage.js` | キャッシュ管理 |
| `extensions/background.js` | バックグラウンドチェック |
| `extensions/sidepanel/sidepanel.js` | UI表示 |
| `extensions/manifest.json` | 権限定義 |

---

## バージョン履歴

| バージョン | 変更内容 |
|-----------|---------|
| v0.2.51 | v0.2.4〜v0.2.7統合、自動ログアウト廃止 |
| v0.2.52 | 1日1回チェック最適化、past_due猶予期間追加 |

---

## 次バージョン予定 (v0.2.6x)

- APIM（Azure API Management）導入
- Rate limiting強化
- API監視・アラート設定
