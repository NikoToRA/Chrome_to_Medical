# 2025-12-24 実装計画 (ログ保存 & エージェント制限)

以下の要件に基づき、修正作業を行います。

## 1. エージェント作成数の制限 (ユーザーデータの肥大化防止)
将来的なクラウド同期 (Table Storage) の容量制限とパフォーマンス維持のため、エージェントの作成数に上限を設けます。

- [ ] **エージェント作成時に個数チェックを追加** (`extensions/sidepanel/sidepanel.js` または `options.js`)
    - 現在のエージェント数が **8個** (デフォルト含む) 以上の場合は、作成をブロックする。
    - ユーザーに「エージェントは最大8個までです」というアラートを表示する。

## 2. 監査ログの保存機能 (ペースト履歴のクラウド保存)
ペースト実行時に、その内容を Azure Blob Storage に保存し、監査ログとして残します。
ユーザー情報は既存の Table Storage に残り、ログだけが Blob Storage に保存される「ハイブリッド構成」となります。

- [ ] **バックエンド接続の修正** (`extensions/sidepanel/sidepanel.js`)
    - 現在: `ApiClient.logInsertion` (エンドポイント `/log-insertion` をコール → 404エラー)
    - 修正: `ApiClient.saveLog` (エンドポイント `/save-log` をコール) に変更する。
    - これにより、ペースト時に `userId/date/timestamp.json` の形式で Blob Storage に保存されるようになる。

---
## 【参考】 将来的なアーキテクチャ (メモ)
今回の実装はこの構成の「Phase 1」にあたります。

### データ保存場所の使い分け
1.  **ユーザー基本情報・権利情報**: Azure Table Storage (既存)
    - 誰がどの有料エージェントを持っているか等はここで管理。
2.  **監査ログ**: Azure Blob Storage (今回実装)
    - 大量のエビデンスデータ。検索機能なし。
3.  **エージェントのマスターデータ**: Azure Blob Storage (管理者領域)
    - 商品としてのエージェント（「ガイドラインエージェント」等）の原本。

### 運用フロー (将来)
1.  運営が Blob に新しいエージェント原本を置く。
2.  ユーザーが購入 → Table Storage に権利情報を書き込む。
3.  拡張機能が起動時に権利を確認し、Blob から原本をダウンロードする。
