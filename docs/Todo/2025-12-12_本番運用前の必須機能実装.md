# 本番運用前の必須機能実装 TODO

**作成日**: 2025-12-12
**優先度**: 本番運用前に必須

---

## 🔴 最優先（本番運用前に必須）

### 1. ウェルカムメール実装（登録完了時）
**ファイル**: `azure-functions/stripe-webhook/index.js`
**トリガー**: `checkout.session.completed`イベント
**実装内容**:
- [ ] `utils/email.js`に`sendWelcomeEmail`関数を追加
- [ ] メール内容:
  - [ ] トライアル期間（14日間無料）の説明
  - [ ] 課金開始日の明示
  - [ ] 主要機能の紹介
  - [ ] サポート連絡先（`company.json`のemail）
  - [ ] Chrome拡張機能の使い方ガイドリンク
- [ ] `checkout.session.completed`でメール送信処理を追加
- [ ] テスト実施

**見積もり時間**: 2-3時間

---

### 2. キャンセル完了メール実装
**ファイル**: `azure-functions/stripe-webhook/index.js`
**トリガー**: `customer.subscription.deleted`イベント
**実装内容**:
- [ ] `utils/email.js`に`sendCancellationEmail`関数を追加
- [ ] メール内容:
  - [ ] キャンセル確認
  - [ ] サービス利用可能期限（`currentPeriodEnd`）
  - [ ] データ保持期限の説明
  - [ ] 再登録の案内とリンク
  - [ ] フィードバック依頼（任意）
- [ ] `customer.subscription.deleted`でメール送信処理を追加
- [ ] テスト実施

**見積もり時間**: 1-2時間

---

### 3. 決済失敗時の対応実装
**ファイル**: `azure-functions/stripe-webhook/index.js`
**トリガー**: `invoice.payment_failed`イベント（新規実装）
**実装内容**:
- [ ] `utils/email.js`に`sendPaymentFailedEmail`関数を追加
- [ ] メール内容:
  - [ ] 決済失敗の通知
  - [ ] 失敗理由（カード期限切れ、残高不足等）
  - [ ] カード情報更新リンク（Stripe Customer Portal）
  - [ ] リトライスケジュール説明
  - [ ] アカウント停止までの猶予期間（Stripeデフォルト設定確認）
  - [ ] サポート連絡先
- [ ] Webhookに`invoice.payment_failed`ケースを追加
- [ ] サブスクリプション状態の更新処理
- [ ] テスト実施（テストカードで失敗シミュレーション）

**見積もり時間**: 3-4時間

---

### 4. 解約後のアクセス制御実装
**ファイル**: `extensions/background.js`, `azure-functions/check-subscription/index.js`
**実装内容**:
- [ ] Chrome拡張機能のバックグラウンドでサブスクリプション状態を定期チェック
- [ ] `check-subscription` APIの拡張:
  - [ ] `status === 'canceled'`の場合、`currentPeriodEnd`を確認
  - [ ] 期限切れの場合は`accessAllowed: false`を返す
- [ ] Chrome拡張機能側でアクセス制御:
  - [ ] 期限切れの場合、機能を無効化
  - [ ] 再登録を促すメッセージ表示
  - [ ] Customer Portalへのリンク表示
- [ ] ローカルストレージにキャッシュ（API呼び出し削減）
- [ ] テスト実施

**見積もり時間**: 4-5時間

---

## 🟡 重要（運用開始後すぐに実装）

### 5. 有料プラン移行通知メール
**ファイル**: `azure-functions/stripe-webhook/index.js`
**トリガー**: トライアル終了時の最初の`invoice.payment_succeeded`
**実装内容**:
- [ ] `utils/email.js`に`sendTrialEndEmail`関数を追加
- [ ] トライアルから有料への移行を判定するロジック
  - [ ] サブスクリプションテーブルで`status: trialing → active`を検出
  - [ ] または`invoice.billing_reason === 'subscription_cycle'`を確認
- [ ] メール内容:
  - [ ] 有料プラン開始の通知
  - [ ] 課金金額の確認
  - [ ] 次回課金日
  - [ ] サービス継続への感謝
  - [ ] カード情報変更・キャンセル方法
- [ ] テスト実施

**見積もり時間**: 2-3時間

---

### 6. Customer Portalへのアクセス導線
**ファイル**: `extensions/sidepanel/sidepanel.html`, `sidepanel.js`
**実装内容**:
- [ ] サイドパネルに「アカウント管理」ボタンを追加
- [ ] クリック時に`create-portal-session` APIを呼び出し
- [ ] 新しいタブでCustomer Portalを開く
- [ ] 以下の操作が可能:
  - [ ] カード情報の更新
  - [ ] サブスクリプションのキャンセル
  - [ ] 請求履歴の確認
  - [ ] 領収書のダウンロード
- [ ] テスト実施

**見積もり時間**: 2-3時間

---

## 🟢 オプション（運用しながら検討）

### 7. 13日目のリマインダーメール
**実装内容**:
- [ ] `check-trial-warning`の拡張（13日目も検出）
- [ ] 「明日課金されます」メール送信
- [ ] テスト実施

**見積もり時間**: 1-2時間

---

### 8. トライアル残り日数の表示
**ファイル**: `extensions/sidepanel/sidepanel.html`
**実装内容**:
- [ ] サブスクリプション情報取得
- [ ] `currentPeriodEnd`から残り日数を計算
- [ ] サイドパネルに「トライアル残り○日」を表示
- [ ] テスト実施

**見積もり時間**: 2-3時間

---

## 📋 実装順序（推奨）

1. **Day 1**: ウェルカムメール実装 + キャンセル完了メール実装（3-5時間）
2. **Day 2**: 決済失敗時の対応実装（3-4時間）
3. **Day 3**: 解約後のアクセス制御実装（4-5時間）
4. **Day 4**: 有料プラン移行通知メール + Customer Portalアクセス導線（4-6時間）
5. **Day 5**: テスト・デバッグ・修正（終日）

**合計見積もり**: 約3-5日間

---

## ⚠️ 注意事項

### Stripe Webhook設定の更新
本番環境移行時に以下のイベントを追加:
- `invoice.payment_failed` ← **新規追加が必要**

### テスト方法
1. **Stripe CLI**でローカルテスト:
   ```bash
   stripe trigger invoice.payment_failed
   stripe trigger customer.subscription.deleted
   ```

2. **テストカード**で実際の決済フロー確認:
   - 成功: `4242 4242 4242 4242`
   - 失敗: `4000 0000 0000 0002`

### メールテンプレート
`azure-functions/utils/email.js`に以下のメソッドを追加:
- `sendWelcomeEmail(email, userName, trialEndDate)`
- `sendCancellationEmail(email, userName, accessEndDate)`
- `sendPaymentFailedEmail(email, userName, failureReason, updateCardUrl)`
- `sendTrialEndEmail(email, userName, amount, nextBillingDate)`

---

## 📝 関連ドキュメント

- Stripe Webhook Events: https://stripe.com/docs/webhooks
- Azure Communication Services: https://docs.microsoft.com/azure/communication-services/
- Chrome Extension Best Practices: https://developer.chrome.com/docs/extensions/

---

## ✅ 完了チェックリスト

本番運用前の確認:
- [ ] すべての🔴最優先機能が実装済み
- [ ] ローカル環境でテスト完了
- [ ] Azure Functions本番環境でテスト完了
- [ ] Stripe本番Webhookが正しく設定されている
- [ ] すべてのメールテンプレートが実際に送信できることを確認
- [ ] Chrome拡張機能でアクセス制御が動作することを確認
- [ ] 決済失敗シナリオのテスト完了
- [ ] 解約シナリオのテスト完了

---

**最終更新**: 2025-12-12
**ステータス**: 未着手
**担当**: 開発チーム
