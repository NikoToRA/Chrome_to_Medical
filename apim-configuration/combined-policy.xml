<policies>
    <inbound>
        <!-- CORS: allow LP + Chrome extension only -->
        <cors allow-credentials="false">
            <allowed-origins>
                <origin>https://stkarteai1763705952.z11.web.core.windows.net</origin>
                <origin>chrome-extension://knldjmfmopnpolahpmmgbagdohdbeiep</origin>
            </allowed-origins>
            <allowed-methods>
                <method>POST</method>
                <method>OPTIONS</method>
                <method>GET</method>
            </allowed-methods>
            <allowed-headers>
                <header>Authorization</header>
                <header>Content-Type</header>
            </allowed-headers>
            <expose-headers>
                <header>Retry-After</header>
            </expose-headers>
        </cors>

        <!-- Minimal rate-limit: protect magic link endpoint by IP (5/min) -->
        <choose>
            <when condition="@(context.Request.MatchedPath.Equals("/api/auth-send-magic-link"))">
                <rate-limit-by-key calls="5" renewal-period="60" counter-key="@(context.Request.IpAddress)" />
            </when>
        </choose>

        <!-- Forward request with sensible timeouts: 180s for chat*, else 120s -->
        <choose>
            <when condition="@(context.Request.MatchedPath.Equals("/api/chat") || context.Request.MatchedPath.Equals("/api/chat-stream"))">
                <forward-request timeout-in-seconds="180" />
            </when>
            <otherwise>
                <forward-request timeout-in-seconds="120" />
            </otherwise>
        </choose>

        <base />
    </inbound>
    <backend>
        <base />
    </backend>
    <outbound>
        <base />
        <!-- Strip backend CORS to avoid duplicates -->
        <set-header name="Access-Control-Allow-Origin" exists-action="delete" />
    </outbound>
    <on-error>
        <base />
    </on-error>
</policies>
