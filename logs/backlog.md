# Chrome to X 拡張機能 - 要件定義・バックログ

## プロジェクト概要
Chrome拡張機能で、サイドバーからテキストと画像を編集・管理し、X（旧Twitter）、Facebook、MicroCMSなど複数のプラットフォームに投稿するためのコンテンツを作成するツール。

## 技術スタック（確定）
- Chrome Extension Manifest V3
- HTML/CSS/JavaScript
- Chrome Storage API（キャッシュ用・ローカルストレージ）
- Chrome Side Panel API（Chrome 114+）- サイドバーを右側に常時表示、Webサイトと並行して操作可能
- Claude API（Anthropic）- AI機能用

## 機能要件

### フェーズ1: 基本機能
#### 1.1 サイドバー表示機能
- **要件**: 拡張機能を有効化するとサイドバーが表示される
- **詳細**:
  - Chrome拡張機能のアイコンクリックでサイドパネルを開く
  - Side Panel APIを使用してブラウザの右側に常時表示
  - Webサイトを行き来してもサイドバーは表示されたまま
  - タブを切り替えてもサイドバーは維持される
  - サイドバーを閉じてもデータはキャッシュに保持
  - 幅400px程度の固定幅で、縦スクロール可能なレイアウト
  - ユーザーが左右の表示位置を選択可能（Chromeの標準機能）

#### 1.2 テキスト編集機能
- **要件**: サイドバー内でテキストを編集できる
- **詳細**:
  - テキストエリアで自由にテキスト入力・編集
  - 文字数カウント表示（リアルタイム更新）
  - 140文字を超えたら文字数カウントを赤色で表示（視覚的な警告）
  - 入力制限は設けない（140文字を超えても入力可能）
  - リアルタイムでプレビュー表示
  - テキストはキャッシュに一時保存

#### 1.3 画像追加機能
- **要件**: サイドバー内に画像を追加できる
- **詳細**:
  - ファイル選択ダイアログから画像を選択
  - 画像プレビュー表示
  - 複数画像の追加に対応（Xの画像制限に合わせる）
  - 画像の削除機能
  - 画像はBase64またはBlob URLとしてキャッシュに保存

#### 1.4 ハッシュタグ管理機能
- **要件**: 記憶させたハッシュタグを編集できる
- **詳細**:
  - よく使うハッシュタグを保存
  - ハッシュタグの追加・削除・編集
  - ハッシュタグをワンクリックでテキストに挿入
  - ハッシュタグはローカルストレージに保存（永続化）

#### 1.5 マルチプラットフォーム投稿用コンテンツ出力機能
- **要件**: 編集したテキストと画像を複数のプラットフォームにコピペできる形式で出力
- **詳細**:
  - テキストをクリップボードにコピー（プラットフォーム別の最適化）
  - 画像は個別にコピーまたはダウンロードリンク提供
  - 各プラットフォームの投稿画面に直接貼り付け可能な形式
  - プラットフォーム選択機能（X、Facebook、MicroCMS、その他）
  - プラットフォーム別の文字数制限表示と警告
  - プラットフォーム別の画像枚数制限チェック

### フェーズ2: ウェブページへのテキスト貼り付け
- **要件**: ウェブ上のカーソル位置にボタンでテキストを貼り付ける
- **詳細**:
  - コンテンツスクリプトでページ上にボタンを表示
  - ボタンクリックでサイドバーのテキストをカーソル位置に貼り付け
  - テキストエリアやinput要素に対応
  - プラットフォーム検出機能（X、Facebook、MicroCMSなど）
  - 検出したプラットフォームに応じた最適化された貼り付け

### フェーズ3: ドラッグ&ドロップ画像取り込み
- **要件**: ウェブ上の画像をドラッグ&ドロップで拡張機能に取り込む
- **詳細**:
  - ウェブページ上の画像をドラッグ可能にする
  - サイドバーにドロップして画像を追加
  - 画像URLまたは画像データを取得

### フェーズ4: スクリーンショット機能
- **要件**: 画像をスクリーンショットして拡張機能に一時保存
- **詳細**:
  - ChromeのスクリーンショットAPIを使用
  - 選択範囲または全画面をキャプチャ
  - キャプチャした画像をサイドバーの画像追加部分に自動追加

### フェーズ5: AI機能統合
#### 5.1 プロンプト管理機能
- **要件**: 決まったプロンプトを選択できる
- **詳細**:
  - プリセットプロンプトの選択UI
  - カスタムプロンプトの追加・編集・削除
  - プロンプトはキャッシュに保存

#### 5.2 AIテキスト生成・編集機能
- **要件**: プロンプトを使用してAIに構成変更を依頼できる
- **詳細**:
  - 選択したプロンプトと現在のテキストをClaude APIに送信
  - Claudeがテキストを生成・編集
  - 生成されたテキストを表示
  - APIキーはユーザーが設定画面で入力（セキュリティ重視）

#### 5.3 AI生成テキストの編集機能
- **要件**: AIが生成したテキストも変更できる
- **詳細**:
  - AI生成テキストをテキストエリアに表示
  - ユーザーが手動で編集可能
  - 編集後も通常のテキストとして扱える

## 非機能要件

### データ管理
- **キャッシュのみ**: 投稿や画像の永続的な保存は行わない
- **ストレージ**: Chrome Storage API（local/session）を使用
- **データ有効期限**: ブラウザセッションまたは拡張機能の設定に応じて

### UI/UX要件
- シンプルで直感的なインターフェース
- レスポンシブデザイン（サイドバーサイズに適応）
- エラーハンドリングとユーザーフィードバック

### パフォーマンス要件
- 画像の読み込み・表示が高速
- キャッシュ操作が軽量
- AI API呼び出し時の適切なローディング表示

## 技術的な考慮事項

### Chrome Extension API
- Manifest V3準拠
- Side Panel API（Chrome 114+）- サイドバー表示
- Action API（サイドパネルを開く）
- Storage API（ローカルストレージ）
- Tabs API
- Scripting API
- Capture API（スクリーンショット用）
- 外部API呼び出し（Claude API用）

### セキュリティ
- コンテンツセキュリティポリシー（CSP）の遵守
- 外部API呼び出し時の適切な権限設定
- ユーザーデータの保護

### 制約事項
- 各プラットフォームの文字数制限に対応
  - X（旧Twitter）: 280文字
  - Facebook: 63,206文字（実用的には数百〜数千文字）
  - MicroCMS: フィールドタイプによる（テキストエリアは無制限、リッチエディタはHTML対応）
- 各プラットフォームの画像制限に対応
  - X: 4枚まで
  - Facebook: 10枚まで（アルバム投稿時）
  - MicroCMS: API制限による（通常は複数枚対応）
- Chrome拡張機能の権限制約内での実装
- 各プラットフォームのAPIポリシーと利用規約の遵守

## 実装優先順位

### Phase 1: MVP（最小機能）
1. サイドバー表示機能
2. テキスト編集機能
3. 画像追加機能（ファイル選択）
4. ハッシュタグ管理機能
5. テキストコピー機能

### Phase 2: ウェブ連携
6. ウェブページへのテキスト貼り付け

### Phase 3: 画像取り込み拡張
7. ドラッグ&ドロップ画像取り込み
8. スクリーンショット機能

### Phase 4: AI機能
9. プロンプト管理機能
10. AIテキスト生成・編集機能
11. AI生成テキストの編集機能

### Phase 5: マルチプラットフォーム対応
12. プラットフォーム選択機能
13. プラットフォーム別の最適化（文字数制限、画像制限）
14. プラットフォーム検出機能（フェーズ2の拡張）
15. MicroCMS拡張フィールド連携（オプション）

## 決定事項

1. **AIサービス**: Claude（Anthropic API）を使用
2. **ハッシュタグ保存方法**: ローカルストレージ（永続化）
3. **サイドバー実装方法**: Side Panel APIを使用（Chrome 114+、右側表示、常時表示可能）
   - Chrome 114は2023年6月リリース、現在のChromeユーザーのほとんどが対応
   - Webサイトを行き来してもサイドバーは表示されたまま
4. **画像保存形式**: Base64またはBlob URL（要検討）
5. **AI APIキー管理**: ユーザーが設定画面で入力（ローカルストレージに暗号化して保存）

## 未確定事項（要検討）

1. **画像保存形式**: Base64/Blob URL/その他（パフォーマンスとメモリ使用量を考慮）
2. **Claude APIバージョン**: Claude 3.5 Sonnet/Claude 3 Opus/その他
3. **APIキーの暗号化方法**: 簡易的なエンコード/本格的な暗号化

## ファイル構成（予定）

```
Chrome_to_X/
├── manifest.json          # 拡張機能の設定ファイル
├── background.js          # バックグラウンドスクリプト
├── sidepanel/
│   ├── sidepanel.html     # サイドパネルHTML
│   ├── sidepanel.css      # サイドパネルスタイル
│   └── sidepanel.js       # サイドパネルロジック
├── content/
│   └── content.js         # コンテンツスクリプト（フェーズ2,3用）
├── options/
│   ├── options.html       # 設定画面（APIキー入力など）
│   ├── options.css        # 設定画面スタイル
│   └── options.js         # 設定画面ロジック
├── icons/                 # 拡張機能アイコン
└── utils/
    ├── storage.js         # ストレージ管理（ローカルストレージ）
    ├── image.js           # 画像処理
    ├── claude.js          # Claude API機能（フェーズ5）
    ├── platforms.js       # プラットフォーム定義・管理（マルチプラットフォーム対応）
    ├── formatter.js       # フォーマット変換（HTML、Markdown、プレーンテキスト）
    └── detector.js        # プラットフォーム検出機能
```

## 次のステップ

1. 画像保存形式の決定（パフォーマンステスト後）
2. Claude APIバージョンの選定
3. 詳細設計の作成
4. 実装開始（フェーズ1から順次）

## 実装上の注意点

### Side Panel APIの実装
- **利点**: サイドバーを常時表示したままWebサイトを閲覧可能
- **データ保持**: データは常にローカルストレージに自動保存し、サイドバーを閉じて開き直しても復元
- **UX**: 保存ボタンは不要（自動保存）、ユーザーに負担をかけない
- **表示位置**: デフォルトで右側に表示、ユーザーがChromeの設定で左右を選択可能

### Claude API統合
- APIキーは設定画面で入力
- エラーハンドリングを適切に実装
- レート制限への対応
- ローディング状態の表示

### 互換性について
- Chrome 114+が必要（2023年6月リリース）
- 現在のChromeユーザーのほとんどが対応済み
- 古いChromeを使用している場合は、バージョンアップを促すメッセージを表示

## マルチプラットフォーム対応の考察

### 対応プラットフォーム

#### X（旧Twitter）
- **文字数制限**: 280文字
- **画像制限**: 4枚まで
- **投稿方法**: クリップボード経由のコピペ（標準的な方法）
- **特徴**: ハッシュタグが重要、140文字を超えたら警告表示

#### Facebook
- **文字数制限**: 63,206文字（実用的には数百〜数千文字）
- **画像制限**: 10枚まで（アルバム投稿時）、通常は複数枚対応
- **投稿方法**: クリップボード経由のコピペ
- **制約**: Facebookは外部アプリからの直接投稿を制限しているため、ユーザーによる手動コピペが基本
- **特徴**: リンクのプレビューが自動生成される、長文投稿が可能

#### MicroCMS
- **文字数制限**: フィールドタイプによる（テキストエリアは無制限、リッチエディタはHTML対応）
- **画像制限**: API制限による（通常は複数枚対応）
- **投稿方法**: 
  - クリップボード経由のコピペ（管理画面のエディタに貼り付け）
  - 拡張フィールド機能を利用した連携（オプション）
- **特徴**: カスタムエディタの組み込みが可能、HTML/Markdown形式での出力が有効

#### その他のプラットフォーム（将来対応）
- Instagram: 2,200文字、画像1枚または動画
- LinkedIn: 3,000文字、画像複数枚対応
- Note: 無制限、Markdown対応
- はてなブログ: 無制限、HTML/Markdown対応

### 実装アプローチ

#### 1. 汎用的なコンテンツ管理
- **統一されたデータ構造**: テキストと画像をプラットフォーム非依存の形式で管理
- **フォーマット変換**: 各プラットフォームに応じた形式に変換（HTML、Markdown、プレーンテキスト）
- **メタデータ管理**: プラットフォーム別の設定（文字数制限、画像制限など）を管理

#### 2. プラットフォーム検出機能
- **URLパターンマッチング**: 現在のタブのURLからプラットフォームを自動検出
- **DOM解析**: ページの構造からプラットフォームを判定
- **ユーザー選択**: 手動でプラットフォームを選択可能

#### 3. プラットフォーム別の最適化
- **文字数カウント**: 選択したプラットフォームに応じた制限値で警告表示
- **画像枚数チェック**: プラットフォーム別の制限をチェック
- **フォーマット変換**: 
  - HTML形式（MicroCMS、はてなブログなど）
  - Markdown形式（Note、MicroCMSなど）
  - プレーンテキスト（X、Facebookなど）

#### 4. クリップボード機能の拡張
- **テキストコピー**: プラットフォームに最適化された形式でコピー
- **画像コピー**: 複数画像を個別にコピー、または一括コピー
- **リッチテキスト対応**: HTML形式でのコピー（MicroCMSなど）

#### 5. MicroCMS拡張フィールド連携（オプション）
- **拡張フィールドAPI**: MicroCMSの拡張フィールド機能を活用
- **カスタムエディタ**: 拡張機能のUIをMicroCMS管理画面に組み込み
- **直接連携**: API経由での直接投稿（認証が必要）

### 技術的な考慮事項

#### プラットフォーム別の制限管理
```javascript
const PLATFORM_LIMITS = {
  'x': { text: 280, images: 4 },
  'facebook': { text: 63206, images: 10 },
  'microcms': { text: null, images: null }, // 制限なし
  // ...
};
```

#### フォーマット変換
- **プレーンテキスト**: X、Facebook用
- **HTML**: MicroCMS、はてなブログ用
- **Markdown**: Note、MicroCMS用

#### 画像処理
- **Base64/Blob URL**: クリップボード経由でコピー可能な形式
- **ファイル形式**: PNG、JPEG、WebP対応
- **サイズ最適化**: プラットフォーム別の推奨サイズに調整（オプション）

### ユーザーエクスペリエンス

#### プラットフォーム選択UI
- サイドバー内にプラットフォーム選択ドロップダウン
- 現在のタブから自動検出したプラットフォームをハイライト
- プラットフォーム別のアイコン表示

#### リアルタイムフィードバック
- 選択したプラットフォームの文字数制限に応じた警告
- 画像枚数制限のチェック
- プレビュー機能（プラットフォーム別の表示確認）

#### コピー機能の改善
- 「テキストのみコピー」「画像も含めてコピー」の選択
- プラットフォーム別の最適化されたコピー形式
- コピー成功時のフィードバック表示

### 実装優先順位（マルチプラットフォーム対応）

1. **Phase 1拡張**: プラットフォーム選択機能の追加
2. **Phase 2拡張**: プラットフォーム検出機能の実装
3. **Phase 3**: プラットフォーム別の最適化（文字数、画像制限）
4. **Phase 4**: フォーマット変換機能（HTML、Markdown）
5. **Phase 5**: MicroCMS拡張フィールド連携（オプション）

### 課題と対策

#### 課題1: プラットフォームの多様性
- **対策**: プラグイン形式でプラットフォーム対応を追加可能にする
- **実装**: プラットフォーム定義をJSON形式で管理し、拡張可能な構造にする

#### 課題2: 画像の扱い方の違い
- **対策**: プラットフォーム別の画像処理ロジックを分離
- **実装**: 画像処理モジュールをプラットフォーム別に実装

#### 課題3: API連携の制限
- **対策**: クリップボード経由のコピペを基本とし、API連携はオプション
- **実装**: 各プラットフォームのポリシーを確認し、可能な範囲で実装

### 将来の拡張性

- **プラグインシステム**: 新しいプラットフォーム対応を追加可能にする
- **カスタムフォーマット**: ユーザーが独自のフォーマットを定義可能にする
- **テンプレート機能**: プラットフォーム別のテンプレートを保存・再利用
- **スケジュール投稿**: 各プラットフォームのAPIを利用した予約投稿（要認証）

