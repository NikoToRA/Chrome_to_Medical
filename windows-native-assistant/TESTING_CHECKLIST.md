# Windows Native Assistant - テストチェックリスト

## Windows環境でのビルド・実行テスト手順

### 事前準備

#### 必要な環境
- [ ] Windows 10 (1809以降) または Windows 11
- [ ] .NET 8.0 SDK インストール済み
- [ ] 管理者権限（初回実行時）

#### アイコンファイルの準備
- [ ] `src/app.ico` を作成（256x256ピクセル推奨）
  - オンラインツール: https://www.icoconverter.com/
  - または Windows 標準の画像エディタを使用

---

## Phase 1: ビルドテスト

### 1.1 プロジェクトのビルド

```cmd
# プロジェクトディレクトリに移動
cd windows-native-assistant

# ビルドスクリプト実行
build.bat
```

#### ✅ 期待される結果
- [ ] NuGetパッケージの復元成功
- [ ] ビルド成功（エラー0、警告0が理想）
- [ ] `publish/WindowsNativeAssistant.exe` が生成される
- [ ] ファイルサイズ: 約50-80MB（self-contained版）

#### ❌ エラー時の対処

**エラー: "app.ico が見つかりません"**
```cmd
# app.ico を作成するか、.csproj から一時的に削除
# <ApplicationIcon>app.ico</ApplicationIcon> をコメントアウト
```

**エラー: "SDK が見つかりません"**
```cmd
# .NET SDK のインストール確認
dotnet --version

# 8.0.x が表示されるはず
```

---

## Phase 2: 基本動作テスト

### 2.1 アプリケーションの起動

```cmd
cd publish
WindowsNativeAssistant.exe
```

#### ✅ 期待される結果
- [ ] システムトレイにアイコンが表示される
- [ ] 起動完了ダイアログが表示される
  - 「Windows Native Assistant が起動しました」
  - 「ホットキー: Control+Alt+A」
- [ ] エラーダイアログが表示されない

#### ❌ エラー時の対処

**エラー: "ホットキーの登録に失敗しました"**
- 他のアプリケーションが Ctrl+Alt+A を使用している
- タスクマネージャーで競合するアプリを終了
- または `%APPDATA%\WindowsNativeAssistant\config.json` でホットキーを変更

**エラー: "初期化に失敗しました"**
- イベントビューアーでエラーログを確認
- `%APPDATA%\WindowsNativeAssistant\logs\errors_*.log` を確認

---

### 2.2 ホットキー動作テスト

#### テスト手順
1. メモ帳（Notepad）を起動
2. メモ帳にフォーカスを置く
3. **Ctrl+Alt+A** を押下

#### ✅ 期待される結果
- [ ] AIパネルが表示される
- [ ] パネルのタイトル: 「AI診療記録生成」
- [ ] テンプレート選択ドロップダウンに3つのオプション
  - SOAP記録
  - 要約
  - 処方メモ
- [ ] 入力欄が空で表示される
- [ ] 「生成して貼り付け」ボタンが有効

#### ❌ トラブルシューティング
- パネルが表示されない → ログ確認
- パネルが他のウィンドウの後ろに隠れる → `Topmost="True"` の確認

---

### 2.3 UI操作テスト

#### テスト手順（パネル表示中）

1. **テンプレート選択**
   - [ ] ドロップダウンをクリック
   - [ ] 3つのテンプレートが表示される
   - [ ] 各テンプレートを選択可能

2. **入力欄**
   - [ ] 複数行のテキスト入力が可能
   - [ ] 日本語入力が可能
   - [ ] スクロールバーが表示される（長文時）

3. **Escキーで閉じる**
   - [ ] Escキー押下でパネルが閉じる

4. **バリデーション**
   - [ ] 入力欄が空の状態で「生成」ボタンをクリック
   - [ ] エラーメッセージが表示される: 「入力内容を記入してください」

---

## Phase 3: AI生成テスト（モック）

### 3.1 設定の確認

```cmd
# 設定ファイルを開く
notepad %APPDATA%\WindowsNativeAssistant\config.json
```

#### ✅ 確認項目
- [ ] `api.endpoint` が正しい
  - `https://func-karte-ai-1763705952.azurewebsites.net/api/chat`
- [ ] `api.timeoutSeconds` が60
- [ ] `paste.retryCount` が2

#### 設定例
```json
{
  "hotkey": {
    "modifiers": "Control+Alt",
    "key": "A"
  },
  "api": {
    "endpoint": "https://func-karte-ai-1763705952.azurewebsites.net/api/chat",
    "token": "",
    "timeoutSeconds": 60
  },
  "paste": {
    "retryCount": 2,
    "retryDelayMs": [200, 500]
  },
  "logging": {
    "enabled": true,
    "includeContent": false,
    "logPath": "logs"
  }
}
```

---

### 3.2 AI生成＋貼り付けテスト（メモ帳）

#### テスト手順

1. **メモ帳を起動**
   ```cmd
   notepad
   ```

2. **メモ帳にフォーカスを置く**

3. **Ctrl+Alt+A でパネルを開く**

4. **入力**
   - テンプレート: 「要約」
   - 入力内容:
     ```
     患者: 65歳男性
     主訴: 頭痛
     現病歴: 2日前から頭痛が持続
     ```

5. **「生成して貼り付け」ボタンをクリック**

#### ✅ 期待される結果

**フェーズ1: AI生成中**
- [ ] パネルに進捗バーが表示される
- [ ] ステータス: 「AI生成中...」
- [ ] ボタンが無効化される

**フェーズ2: 生成完了**
- [ ] パネルが自動的に閉じる
- [ ] 200-500ms の待機後

**フェーズ3: 自動貼り付け**
- [ ] メモ帳にフォーカスが戻る
- [ ] AI生成結果が自動的に貼り付けられる
- [ ] 「貼り付けが完了しました」ダイアログが表示される

**生成結果例**（AIによる）
```
【診療記録要約】

患者: 65歳男性
主訴: 頭痛
現病歴: 2日前から頭痛が持続しており、経過観察が必要。

（実際の出力はAIの応答による）
```

#### ❌ エラー時の対処

**エラー: "AI生成に失敗しました"**
- ネットワーク接続確認
- Azure Functions エンドポイントの確認
- タイムアウト設定を増やす（config.json）

**エラー: "貼り付けに失敗しました"**
- メモ帳が最前面にあるか確認
- ログファイルで失敗理由を確認
  ```cmd
  notepad %APPDATA%\WindowsNativeAssistant\logs\operations_*.log
  ```

---

### 3.3 貼り付けリトライテスト

#### テスト手順（フォーカス競合をシミュレート）

1. メモ帳を起動
2. Ctrl+Alt+A でパネルを開く
3. 入力して「生成」ボタンをクリック
4. **生成中に別のウィンドウをアクティブにする**（例: ブラウザ）

#### ✅ 期待される結果
- [ ] リトライが実行される（最大3回試行）
- [ ] 最終的にメモ帳にフォーカスが戻る
- [ ] 貼り付けが成功する

または

- [ ] 3回試行後に失敗
- [ ] エラーダイアログ: 「貼り付けに失敗しました」
  - 理由: フォーカス復帰失敗
  - 試行回数: 3

---

## Phase 4: 各種環境でのテスト

### 4.1 Google Docs（Chrome）

#### テスト手順
1. Chrome で Google Docs を開く
2. ドキュメントの編集モードにする
3. Ctrl+Alt+A でパネルを開く
4. AI生成＋貼り付け実行

#### ✅ 期待される結果
- [ ] Google Docs に貼り付けが成功する
- [ ] 改行が保持される
- [ ] 日本語が文字化けしない

---

### 4.2 Excel

#### テスト手順
1. Excel を起動
2. セルを選択
3. Ctrl+Alt+A でパネルを開く
4. AI生成＋貼り付け実行

#### ✅ 期待される結果
- [ ] セルに貼り付けが成功する
- [ ] 複数行の場合、セル内で改行される

---

### 4.3 EMS MAPS（実環境）

#### ⚠️ 重要な注意事項
- **本番環境では絶対にテストしない**
- **テスト環境または練習用アカウントで実施**
- **患者情報を使用しない**

#### テスト手順
1. EMS MAPS を起動（テスト環境）
2. 入力欄にフォーカスを置く
3. Ctrl+Alt+A でパネルを開く
4. テストデータで生成＋貼り付け

#### ✅ 期待される結果
- [ ] MAPS の入力欄に貼り付けが成功する
- [ ] カーソル位置が正しい
- [ ] 文字化けや文字抜けがない

#### 🔍 確認項目
- [ ] IME状態（日本語/英語）に関係なく動作する
- [ ] 複数行の貼り付けが正しく動作する
- [ ] 特殊文字（改行、タブ等）が正しく処理される

---

## Phase 5: システムトレイ機能テスト

### 5.1 トレイアイコン

#### ✅ 確認項目
- [ ] システムトレイにアイコンが表示される
- [ ] アイコンをホバーするとツールチップが表示される
  - 「Windows Native Assistant - Ready」

---

### 5.2 右クリックメニュー

#### テスト手順
1. トレイアイコンを右クリック

#### ✅ 期待される結果
- [ ] コンテキストメニューが表示される
  - Open Panel
  - Settings
  - （区切り線）
  - Exit

---

### 5.3 設定ウィンドウ

#### テスト手順
1. トレイアイコン → Settings

#### ✅ 期待される結果
- [ ] 設定ウィンドウが表示される
- [ ] 現在のホットキーが表示される
- [ ] API設定が表示される
- [ ] ログ設定が表示される

#### 設定変更テスト
1. **タイムアウト変更**
   - [ ] 60 → 120 に変更
   - [ ] 「保存」ボタンをクリック
   - [ ] 成功メッセージが表示される
   - [ ] `config.json` を確認（120になっている）

2. **ログ設定変更**
   - [ ] 「生成内容をログに含める」をON
   - [ ] 保存後、`config.json` で `includeContent: true` を確認

---

## Phase 6: ログ確認テスト

### 6.1 操作ログ

#### テスト手順
1. 何度かAI生成＋貼り付けを実行
2. ログファイルを開く
   ```cmd
   notepad %APPDATA%\WindowsNativeAssistant\logs\operations_2026-01-04.log
   ```

#### ✅ 期待される結果

ログエントリの例:
```
[2026-01-04 14:30:15]
Template: summary
Success: True
Attempts: 1
Target Window: 0x12345
--------------------------------------------------------------------------------

[2026-01-04 14:32:20]
Template: soap
Success: False
Attempts: 3
Failure Reason: Failed to restore focus to target window
Failure Type: FocusRestoreFailed
Target Window: 0x67890
--------------------------------------------------------------------------------
```

#### ✅ 確認項目
- [ ] 各操作がログに記録されている
- [ ] 時刻が正確
- [ ] 成功/失敗が記録されている
- [ ] 試行回数が記録されている
- [ ] デフォルトでは本文が記録されていない

---

### 6.2 エラーログ

#### テスト手順
1. 意図的にエラーを発生させる
   - ネットワークを切断して生成を試行
   - 無効な API エンドポイントを設定
2. エラーログを確認
   ```cmd
   notepad %APPDATA%\WindowsNativeAssistant\logs\errors_2026-01-04.log
   ```

#### ✅ 期待される結果
```
[2026-01-04 14:35:00] ERROR
Message: AI generation failed
Exception: HttpRequestException
Details: No such host is known
Stack Trace: ...
--------------------------------------------------------------------------------
```

---

## Phase 7: 負荷テスト

### 7.1 連続実行テスト

#### テスト手順
1. 10回連続でAI生成＋貼り付けを実行
2. パフォーマンスを観察

#### ✅ 期待される結果
- [ ] メモリリークがない（タスクマネージャーで確認）
- [ ] 応答速度が低下しない
- [ ] クラッシュしない

---

### 7.2 長時間稼働テスト

#### テスト手順
1. アプリを起動したまま8時間放置
2. 定期的にホットキーを押して動作確認

#### ✅ 期待される結果
- [ ] 正常に動作し続ける
- [ ] メモリ使用量が異常増加しない
- [ ] ホットキーが応答し続ける

---

## Phase 8: エラーリカバリテスト

### 8.1 ネットワーク切断

#### テスト手順
1. ネットワークを切断
2. AI生成を試行

#### ✅ 期待される結果
- [ ] タイムアウト後にエラーメッセージが表示される
- [ ] 「ネットワークエラー」と明記される
- [ ] アプリがクラッシュしない

---

### 8.2 設定ファイル破損

#### テスト手順
1. `config.json` を破損させる（不正なJSON）
2. アプリを再起動

#### ✅ 期待される結果
- [ ] デフォルト設定で起動する
- [ ] エラーログに記録される
- [ ] 新しい `config.json` が生成される

---

## Phase 9: セキュリティテスト

### 9.1 ログの個人情報確認

#### テスト手順
1. 患者情報を含む入力で生成（テストデータ）
2. ログファイルを確認

#### ✅ 期待される結果
- [ ] デフォルトでは本文が記録されていない
- [ ] 設定で `includeContent: true` にした場合のみ記録される

---

### 9.2 認証トークンの保管

#### テスト手順
1. `config.json` を確認

#### ⚠️ 現状の制限
- [ ] トークンは平文で保存される
- [ ] `%APPDATA%` はユーザー専用領域（他ユーザーからは保護）

#### 将来の改善（Phase 2）
- Windows Credential Manager への移行

---

## 最終チェックリスト

### ✅ すべてのテストが完了したら

- [ ] ビルドが成功した
- [ ] 基本動作（ホットキー、パネル表示）が正常
- [ ] AI生成が成功した
- [ ] メモ帳への貼り付けが成功した
- [ ] Google Docs への貼り付けが成功した
- [ ] EMS MAPS（テスト環境）での貼り付けが成功した
- [ ] ログが正しく記録されている
- [ ] エラー処理が適切に動作している
- [ ] 長時間稼働で問題がない
- [ ] セキュリティ要件を満たしている

### 📋 本番展開前の最終確認

- [ ] アイコンファイルが設定されている
- [ ] ログに個人情報が含まれないことを確認
- [ ] ユーザーマニュアルを作成した
- [ ] サポート体制を整えた
- [ ] バックアップと復旧手順を文書化した

---

## トラブルシューティング早見表

| 症状 | 原因 | 対処法 |
|------|------|--------|
| ホットキーが効かない | 衝突 | config.json でキー変更 |
| パネルが表示されない | ログ確認 | errors_*.log を確認 |
| 生成が失敗する | ネットワーク/API | エンドポイント確認 |
| 貼り付けが失敗する | フォーカス | 対象ウィンドウを最前面に |
| クラッシュする | 未処理例外 | イベントビューアー確認 |

---

**テスト実施者**: _______________
**実施日**: _______________
**テスト環境**: Windows ___ / .NET ___
**結果**: ✅ 合格 / ❌ 不合格
