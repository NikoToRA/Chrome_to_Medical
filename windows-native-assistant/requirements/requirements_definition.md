# 要件定義：Windows Native Assistant（EMS MAPS向け / MVP）

## 1. 概要

### 1.1 背景
現状はChrome拡張として、Web画面上の入力体験に対してAI機能を差し込み、生成結果を貼り付けることで業務効率化を実現している。

一方、クリニックでは **オンプレ/専用クライアント** で稼働する電子カルテも多く、ブラウザ拡張では同等のUXを提供できない。

### 1.2 目的
EMSのMAPS（Windowsネイティブに見えるクライアント）を対象に、**ワンプッシュでAIを呼び出し、結果をMAPSのカーソル位置へ自動貼り付け**できるWindows常駐アプリを提供する。

### 1.3 スコープ（MVP）
- Windows常駐（トレイ）アプリとして提供
- グローバルホットキー（またはフローティングボタン）で起動
- AI生成（SOAP/要約などのテンプレ）
- 生成結果の **自動貼り付け（ユーザー操作不要）**

### 1.4 スコープ外（当面）
- MAPS内の複数フィールド（主訴/所見/計画等）への自動振り分け
- OCRによる画面読み取り
- 電子カルテベンダーAPI/FHIR/HL7等の正規連携
- 施設ごとの詳細ワークフロー最適化（まずは単一入力欄で成立させる）

## 2. 前提・制約

### 2.1 前提
- 対象は **EMS MAPS**
- 院内端末はWeb接続可能
- 院内端末への常駐アプリのインストールは許可されている
- 初期要件として、貼り付け対象は **MAPSでカーソルが当たっている入力箇所**

### 2.2 制約
- **自動貼り付けは必須**（クリップボードに入れるだけは不可）
- Windowsネイティブに見えるアプリに対して動作する必要がある（Web DOM前提不可）

## 3. ステークホルダー / 想定ユーザー
- 医師
- 看護師/クラーク（入力補助）
- 院内情シス（最小）

## 4. ユースケース（MVP）

### UC-01：ワンプッシュでAI生成→自動貼り付け
- 事前条件：MAPSの入力欄にカーソルがある
- トリガー：ホットキー（例：Alt+Space）
- 主シナリオ：
  1) 小型パネルが表示されテンプレ選択（SOAP/要約など）
  2) 必要なら入力（メモ/箇条書き）を追加
  3) 実行
  4) 生成完了
  5) アプリがMAPSへフォーカスを戻し、**自動で貼り付け**（必要に応じて確定キー）
- 代替/例外：
  - フォーカス復帰に失敗 → リトライ → 最終的にユーザーへ明確に通知（貼り付け未完了を必ず伝える）

## 5. 機能要件

### 5.1 起動・操作
- FR-01：グローバルホットキーでAIパネルを開ける
- FR-02：パネル上でテンプレ（SOAP/要約…）を選択できる
- FR-03：生成開始/キャンセルができる

### 5.2 AI生成
- FR-10：クラウドのAI APIへリクエストし、結果を受け取れる
- FR-11：テンプレごとにプロンプト/出力形式を切り替えられる

### 5.3 自動貼り付け（必須）
- FR-20：生成結果をクリップボードに格納できる
- FR-21：生成完了後、直前にアクティブだったMAPSウィンドウへフォーカスを戻せる
- FR-22：フォーカス復帰後に **Ctrl+V 相当の貼り付けを自動実行**できる
- FR-23：貼り付けの成功/失敗をユーザーに明確に通知する
- FR-24：失敗時に安全なリトライ（回数/間隔）を実行できる

### 5.4 ログ・設定（MVP最小）
- FR-30：ローカルに最低限の動作ログ（成功/失敗、時刻、テンプレ種別）を残せる
- FR-31：ホットキーを設定変更できる（衝突回避）

## 6. 非機能要件

### 6.1 UX/パフォーマンス
- NFR-01：ホットキー押下からパネル表示まで 300ms 目標
- NFR-02：貼り付け完了までの全体待ち時間を短く見せる（進捗表示）

### 6.2 信頼性
- NFR-10：貼り付け失敗を黙って成功扱いにしない（誤入力防止）
- NFR-11：フォーカス制御/キー送出はリトライ戦略を持つ

### 6.3 セキュリティ/個人情報
- NFR-20：通信はTLS
- NFR-21：ログに患者情報本文を残さない（デフォルト）
- NFR-22：APIキー/トークンはOSの安全な保管領域を利用（実装時に定義）

### 6.4 運用
- NFR-30：自動アップデート or 管理者配布のいずれかを選べるようにする（方針は別途）

## 7. 受入基準（MVPの定量目標）
- AC-01：MAPS上でカーソルがある入力欄に対し、ホットキー1回でAI生成し、**ユーザー操作なしで貼り付け完了**できる
- AC-02：貼り付け失敗時は必ず通知され、誤って成功と表示しない
- AC-03：ホットキー衝突時に変更できる

## 8. 想定リスクと対策（初期）
- R-01：MAPS側が特殊コントロールでCtrl+Vが効かない
  - 対策：UI Automation（UIA）による入力欄への直接セットを検討。最低でもフォールバック手段を用意。
- R-02：フォーカス復帰が不安定（ユーザーが別画面へ移動）
  - 対策：直前アクティブウィンドウの保持、復帰リトライ、復帰できない場合の明確通知
- R-03：IME状態により貼り付けが崩れる
  - 対策：貼り付け直前のIME制御/短い待機/再送

## 9. 今後の拡張（ロードマップ案）
- 複数フィールドへの自動振り分け（MAPS UIAアダプタ）
- テンプレ/プロンプトの施設別配布
- 正規連携（可能なら）
