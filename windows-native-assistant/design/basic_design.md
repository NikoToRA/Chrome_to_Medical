# 基本設計：Windows Native Assistant（EMS MAPS向け / MVP）

## 1. 設計のゴール（MVP）

- EMS MAPS（Windowsネイティブに見えるクライアント）上で
- ユーザーが **ホットキー1回**でAI実行を起動し
- AI生成結果を **ユーザー操作なし**で「MAPSのカーソルが当たっている入力箇所」へ **自動貼り付け**する

前提・要件の一次ソース：`../requirements/requirements_definition.md`

---

## 2. 全体アーキテクチャ

### 2.1 コンポーネント

- **Windows常駐クライアント**（トレイ常駐）
  - UI（小型パネル）
  - Hotkeyマネージャ
  - AIクライアント（HTTP）
  - **貼り付けエンジン**（フォーカス復帰＋クリップボード＋Ctrl+V送出）
  - 設定/ログ

- **クラウドAI API**（既存資産を流用想定）
  - テンプレ別プロンプト
  - 認証（トークン）
  - 監査ログ方針（本文保存しないがデフォルト）

### 2.2 データフロー（MVP）

1. ユーザー：MAPS上の入力欄へカーソル
2. ユーザー：ホットキー押下
3. クライアント：パネル表示 → テンプレ選択/メモ入力
4. クライアント：AI APIへリクエスト
5. クライアント：AI結果を受信
6. クライアント：
   - 「直前アクティブだったウィンドウ（MAPS想定）」を特定/保持
   - MAPSへフォーカス復帰
   - クリップボードへ結果を書き込み
   - **Ctrl+V 相当を送出**
   - 成否通知

---

## 3. UI/UX設計（MVP）

### 3.1 画面（最小）

- **トレイアイコン**
  - 状態：待機/生成中/エラー
  - 右クリック：設定/ログ表示/終了

- **小型AIパネル**（ホットキーで表示、Escで閉じる）
  - テンプレ選択（例：SOAP/要約）
  - 入力欄（任意）：箇条書き/メモ
  - 実行ボタン
  - 進捗表示（生成中）
  - 完了トースト（貼り付け成功/失敗）

### 3.2 UXルール

- 生成完了後は、**ユーザー操作なしで貼り付け完了**まで自動で進める
- 貼り付け失敗は「成功」に見せない（誤入力防止）
- 失敗時は「次に何をすればよいか」を通知（例：MAPS入力欄にカーソルを戻して再実行）

---

## 4. 主要モジュール設計

### 4.1 HotkeyManager

- OS全体でホットキーを登録
- ホットキー衝突時は設定画面で変更可能
- 押下時に `AppController.onHotkey()` を呼ぶ

### 4.2 PanelUI

- テンプレ選択・メモ入力・実行
- 実行時に `AppController.runGenerateAndPaste(template, memo)`
- 進捗と結果通知

### 4.3 AIClient

- `generate(templateId, userText, context)`
- タイムアウト（例：60s）とリトライ（ネットワーク系のみ）
- 送信内容は最小化（MVPはユーザー入力のみ）

### 4.4 PasteEngine（最重要）

目的：**MAPS（直前アクティブウィンドウ）へ戻し、ユーザー操作なしで貼り付けを完了**させる。

#### 4.4.1 入出力

- 入力：`targetWindowHandle`（直前アクティブのHWND）、`text`（貼り付け内容）
- 出力：`PasteResult { success: boolean, reason?: string, attempts: number }`

#### 4.4.2 基本アルゴリズム（MVP）

- (A) **ターゲット保持**：ホットキー押下時点のアクティブウィンドウHWNDを保存
- (B) **フォーカス復帰**：生成完了後、保存HWNDを前面化
- (C) **クリップボード書き込み**：Unicodeテキストで格納
- (D) **キー送出**：`Ctrl+V` をSendInput等で送出
- (E) **成功通知**：最小は「送出完了」を成功扱いにしつつ、将来はUIAで反映確認を追加

#### 4.4.3 リトライ戦略（必須）

失敗しやすいポイントは「フォーカスが戻っていない」「MAPS側が忙しい」「IME状態」「Ctrl+Vが吸われる」。

- リトライ回数：2回（MVP）
- 間隔：200ms → 500ms（指数バックオフ風）
- 1回ごとに
  - フォーカス復帰を再実行
  - クリップボード再書き込み
  - `Ctrl+V` 再送

#### 4.4.4 失敗分類（ログ/通知用）

- `FocusRestoreFailed`：前面化に失敗
- `ClipboardWriteFailed`：クリップボード書き込み失敗
- `SendKeysFailed`：キー送出失敗
- `PasteNoEffectSuspected`：送出したが反映が疑わしい（将来UIAで検知）

#### 4.4.5 セーフティ（誤貼り付け対策）

- 生成開始時点で **ターゲットHWNDを固定**
- 貼り付け直前に
  - 現在の前面ウィンドウが保存HWNDと一致するかチェック
  - 一致しない場合は復帰を試行、最終的に一致しなければ失敗扱い

> 注：MVPでは「フォーカス復帰＋HWND一致確認」で誤貼り付けを抑止する。より厳密にする場合はプロセス名/署名等の追加チェックを検討。

---

## 5. 状態管理（アプリ内ステート）

- `Idle`
- `PanelOpen`
- `Generating`
- `Pasting`
- `Success` / `Failure`

状態遷移は `AppController` が一元管理し、UIは状態を購読して表示を更新する。

---

## 6. 設定設計

### 6.1 ローカル設定（MVP）

- ホットキー設定
- リトライ回数/間隔（任意）
- APIエンドポイント
- 認証トークン（保管方法はOSの安全領域：実装フェーズで確定）

---

## 7. ログ設計（MVP）

### 7.1 目的

- 成功率/失敗原因の把握
- 施設導入時のトラブルシュート

### 7.2 ログに含める（本文は含めない）

- 時刻
- テンプレID
- 貼り付け結果（成功/失敗/失敗理由）
- リトライ回数
- 対象ウィンドウ情報（HWND、プロセス名などは個人情報ではない範囲で）

---

## 8. セキュリティ/プライバシー（MVP）

- 通信はTLS
- ローカルログには患者情報本文を出さない（デフォルト）
- トークンは平文ファイル保存を避け、OSの安全な保管を利用（実装時に具体化）

---

## 9. 例外・エラー時の挙動

- ネットワークエラー：再試行（生成側）→ 失敗通知
- 生成成功・貼り付け失敗：
  - 自動リトライ
  - 最終失敗は明確通知（「MAPS入力欄にカーソルを置いて再実行」）
  - 以降の誤貼り付けを防ぐため、勝手に別ウィンドウへ貼らない

---

## 10. 将来拡張ポイント

- UI Automation（UIA）で貼り付け結果の反映確認
- MAPS専用アダプタ：特定フィールド入力/複数フィールド分配
- 施設別テンプレ/プロンプト配布
- 正規連携（可能なら）
